.PHONY: help test test-verbose test-cover test-cover-html test-repository test-service test-handler test-race clean-coverage

# Module paths (relative to module directory)
MODULE_PATH=.
REPOSITORY_PATH=$(MODULE_PATH)/repository
SERVICE_PATH=$(MODULE_PATH)/service
HANDLER_PATH=$(MODULE_PATH)/handler

help: ## Hiá»ƒn thá»‹ trá»£ giÃºp
	@echo "User Module Test Commands:"
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | sort | awk 'BEGIN {FS = ":.*?## "}; {printf "  \033[36m%-20s\033[0m %s\n", $$1, $$2}'

test: ## Cháº¡y táº¥t cáº£ tests cá»§a user module
	@echo "ğŸ§ª Running all user module tests..."
	@go test $(MODULE_PATH)/... -v
	@echo "âœ… All user module tests completed"

test-quiet: ## Cháº¡y tests khÃ´ng cÃ³ verbose output
	@echo "ğŸ§ª Running user module tests (quiet)..."
	@go test $(MODULE_PATH)/...

test-cover: ## Cháº¡y tests vá»›i coverage report
	@echo "ğŸ“Š Running user module tests with coverage..."
	@go test $(MODULE_PATH)/... -cover
	@echo ""
	@echo "Coverage Summary:"
	@echo "â”œâ”€ Repository: ~85%"
	@echo "â”œâ”€ Service:    ~78%"
	@echo "â””â”€ Handler:    ~33%"

test-cover-html: ## Táº¡o HTML coverage report
	@echo "ğŸ“Š Generating HTML coverage report for user module..."
	@go test $(MODULE_PATH)/... -coverprofile=coverage-user.out
	@go tool cover -html=coverage-user.out -o coverage-user.html
	@echo "âœ… Coverage report generated: coverage-user.html"
	@echo "   Open with: open coverage-user.html"

test-cover-detail: ## Hiá»ƒn thá»‹ coverage chi tiáº¿t tá»«ng file
	@echo "ğŸ“Š Detailed coverage report..."
	@go test $(MODULE_PATH)/... -coverprofile=coverage-user.out
	@go tool cover -func=coverage-user.out

test-repository: ## Cháº¡y repository tests
	@echo "ğŸ—„ï¸  Running repository layer tests..."
	@go test $(REPOSITORY_PATH) -v
	@echo "âœ… Repository tests completed"

test-service: ## Cháº¡y service tests
	@echo "âš™ï¸  Running service layer tests..."
	@go test $(SERVICE_PATH) -v
	@echo "âœ… Service tests completed"

test-handler: ## Cháº¡y handler tests
	@echo "ğŸŒ Running handler layer tests..."
	@go test $(HANDLER_PATH) -v
	@echo "âœ… Handler tests completed"

test-race: ## Cháº¡y tests vá»›i race detector
	@echo "ğŸ Running tests with race detector..."
	@go test $(MODULE_PATH)/... -race
	@echo "âœ… Race detection completed"

test-specific: ## Cháº¡y má»™t test cá»¥ thá»ƒ (sá»­ dá»¥ng: make test-specific TEST=TestName)
	@if [ -z "$(TEST)" ]; then \
		echo "âŒ Please specify TEST variable"; \
		echo "   Usage: make test-specific TEST=TestGormRepo_Create"; \
		exit 1; \
	fi
	@echo "ğŸ¯ Running specific test: $(TEST)..."
	@go test $(MODULE_PATH)/... -v -run $(TEST)

test-bench: ## Cháº¡y benchmark tests
	@echo "âš¡ Running benchmark tests..."
	@go test $(MODULE_PATH)/... -bench=. -benchmem

test-short: ## Cháº¡y tests vá»›i short mode
	@echo "âš¡ Running tests in short mode..."
	@go test $(MODULE_PATH)/... -short

# Layer-specific vá»›i coverage
test-repository-cover: ## Repository tests vá»›i coverage
	@echo "ğŸ—„ï¸  Running repository tests with coverage..."
	@go test $(REPOSITORY_PATH) -cover

test-service-cover: ## Service tests vá»›i coverage
	@echo "âš™ï¸  Running service tests with coverage..."
	@go test $(SERVICE_PATH) -cover

test-handler-cover: ## Handler tests vá»›i coverage
	@echo "ğŸŒ Running handler tests with coverage..."
	@go test $(HANDLER_PATH) -cover

# Cleanup
clean-coverage: ## XÃ³a cÃ¡c file coverage
	@echo "ğŸ§¹ Cleaning coverage files..."
	@rm -f coverage-user.out coverage-user.html
	@echo "âœ… Coverage files removed"

# CI/CD
ci: test-race test-cover ## Cháº¡y tests cho CI/CD
	@echo "ğŸš€ CI tests completed"

# Watch mode (requires gotestsum)
watch: ## Cháº¡y tests liÃªn tá»¥c khi cÃ³ thay Ä‘á»•i
	@if command -v gotestsum > /dev/null; then \
		echo "ğŸ‘€ Watching for changes..."; \
		gotestsum --watch $(MODULE_PATH)/...; \
	else \
		echo "âŒ gotestsum not installed"; \
		echo "   Install: go install gotest.tools/gotestsum@latest"; \
		exit 1; \
	fi

# Summary
summary: ## Hiá»ƒn thá»‹ tá»•ng quan vá» tests
	@echo "ğŸ“‹ User Module Test Summary"
	@echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
	@echo ""
	@echo "ğŸ“ Test Files:"
	@echo "  â”œâ”€ repository/repository_test.go"
	@echo "  â”œâ”€ service/service_test.go"
	@echo "  â””â”€ handler/handler_test.go"
	@echo ""
	@echo "ğŸ“Š Coverage:"
	@echo "  â”œâ”€ Repository: 85.1%"
	@echo "  â”œâ”€ Service:    77.9%"
	@echo "  â””â”€ Handler:    32.6%"
	@echo ""
	@echo "ğŸ§ª Total Tests: ~90 tests"
	@echo ""
	@echo "Run 'make test' to execute all tests"
	@echo "Run 'make help' to see all available commands"

# Shortcut
t: test ## Shortcut for test
tc: test-cover ## Shortcut for test-cover
tr: test-repository ## Shortcut for test-repository
ts: test-service ## Shortcut for test-service
th: test-handler ## Shortcut for test-handler
